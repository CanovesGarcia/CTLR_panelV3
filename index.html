<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>CTRLPANEL</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root {
  --bg: #0b0d13;
  --panel: #11141d;
  --panel2: #171b27;
  --border: #1e2235;
  --border2: #2a2f47;
  --accent: #4f9eff;
  --accent-dim: rgba(79,158,255,0.13);
  --orange: #ff6b35;
  --orange-dim: rgba(255,107,53,0.13);
  --green: #2ecc71;
  --green-dim: rgba(46,204,113,0.11);
  --yellow: #f5c842;
  --yellow-dim: rgba(245,200,66,0.11);
  --red: #ff4757;
  --text: #dde1f0;
  --text2: #8b93ad;
  --muted: #454d6a;
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); display:flex; flex-direction:column; }

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HEADER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.header {
  height: 52px;
  display: flex;
  align-items: center;
  padding: 0 14px;
  gap: 8px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  z-index: 100;
}
.logo {
  font-family:'Rajdhani',sans-serif;
  font-size:16px; font-weight:700;
  letter-spacing:3px; color:var(--accent);
  white-space:nowrap;
}
.logo em{color:var(--text2);font-style:normal;font-weight:500;}
.project-input {
  font-size:12px; color:var(--text2);
  padding:4px 8px;
  border:1px solid var(--border2); border-radius:4px;
  background:var(--panel2);
  font-family:'DM Mono',monospace;
  min-width:0; flex:1; max-width:200px;
  transition:border-color .2s;
}
.project-input:focus{outline:none;border-color:var(--accent);color:var(--text);}
.hspacer{flex:1;}
.hbtn {
  display:flex; align-items:center; gap:5px;
  padding:5px 10px; border-radius:6px;
  border:1px solid var(--border2); background:transparent;
  color:var(--text2); font-family:'DM Mono',monospace;
  font-size:10px; letter-spacing:.8px;
  cursor:pointer; transition:all .2s; white-space:nowrap;
  flex-shrink:0;
}
.hbtn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim);}
.hbtn.edit-on{border-color:var(--yellow);color:var(--yellow);background:var(--yellow-dim);}
.hbtn.gh.ok{border-color:var(--green);color:var(--green);background:var(--green-dim);}
.hbtn.share{border-color:var(--green);color:var(--green);background:var(--green-dim);}
.hbtn:disabled{opacity:.35;cursor:not-allowed;pointer-events:none;}
.led{width:6px;height:6px;border-radius:50%;background:var(--muted);transition:background .2s;}
.hbtn.edit-on .led{background:var(--yellow);animation:blink 1.2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN LAYOUT
   Desktop: image | side panel
   Mobile:  stacked, panel slides up
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.workspace {
  display: flex;
  flex: 1;
  overflow: hidden;
  position: relative;
}

/* ‚îÄ‚îÄ IMAGE ZONE ‚îÄ‚îÄ */
.image-zone {
  flex: 1;
  background: #07080e;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
  min-width: 0;
}

/* Drop zone */
.drop-zone {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: calc(100% - 48px);
  height: calc(100% - 48px);
  border: 2px dashed var(--border2);
  border-radius: 14px;
  cursor: pointer;
  transition: all .25s;
  color: var(--muted);
  text-align: center;
  padding: 24px;
}
.drop-zone:hover,.drop-zone.over{border-color:var(--accent);background:var(--accent-dim);color:var(--accent);}
.dz-icon{font-size:40px;opacity:.3;}
.drop-zone h2{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;letter-spacing:1px;}
.drop-zone p{font-size:13px;line-height:1.7;max-width:240px;}
.dz-btn{padding:8px 20px;background:var(--accent-dim);border:1px solid var(--accent);color:var(--accent);border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.dz-btn:hover{background:rgba(79,158,255,.26);}

/* Image canvas */
.img-canvas{position:relative;display:none;user-select:none;line-height:0;}
.img-canvas img{
  max-height: calc(100dvh - 52px);
  max-width: 100%;
  display:block;
  filter:brightness(.82);
  object-fit:contain;
}
.img-canvas.crosshair{cursor:crosshair!important;}

/* ‚îÄ‚îÄ HOTSPOTS ‚îÄ‚îÄ */
.hs{position:absolute;width:32px;height:32px;transform:translate(-50%,-50%);cursor:pointer;z-index:20;}
.hsr{width:32px;height:32px;border-radius:50%;border:2px solid var(--accent);background:rgba(79,158,255,.18);display:flex;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:12px;color:var(--accent);transition:transform .2s,box-shadow .2s;animation:rp 3s ease-in-out infinite;}
.hs.power .hsr{border-color:var(--orange);background:var(--orange-dim);color:var(--orange);animation:rpo 3s ease-in-out infinite;}
.hs.safe  .hsr{border-color:var(--green);background:var(--green-dim);color:var(--green);animation:rpg 3s ease-in-out infinite;}
.hs:hover .hsr,.hs.active .hsr{transform:scale(1.25);box-shadow:0 0 24px rgba(79,158,255,.4);}
.hs.power:hover .hsr,.hs.power.active .hsr{box-shadow:0 0 24px rgba(255,107,53,.4);}
.hs.safe:hover  .hsr,.hs.safe.active  .hsr{box-shadow:0 0 24px rgba(46,204,113,.35);}
@keyframes rp {0%,100%{box-shadow:0 0 0 0 rgba(79,158,255,.45)}60%{box-shadow:0 0 0 9px rgba(79,158,255,0)}}
@keyframes rpo{0%,100%{box-shadow:0 0 0 0 rgba(255,107,53,.45)}60%{box-shadow:0 0 0 9px rgba(255,107,53,0)}}
@keyframes rpg{0%,100%{box-shadow:0 0 0 0 rgba(46,204,113,.45)}60%{box-shadow:0 0 0 9px rgba(46,204,113,0)}}
.hs-tip{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border2);color:var(--text);font-size:11px;font-weight:500;padding:4px 10px;white-space:nowrap;border-radius:4px;opacity:0;pointer-events:none;transition:opacity .15s;box-shadow:0 4px 16px rgba(0,0,0,.6);z-index:30;}
.hs:hover .hs-tip{opacity:1;}
.hs-del{display:none;position:absolute;top:-5px;right:-5px;width:16px;height:16px;border-radius:50%;background:var(--red);color:#fff;font-size:8px;align-items:center;justify-content:center;cursor:pointer;z-index:30;font-weight:700;}
.edit-mode .hs-del{display:flex;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIDE PANEL ‚Äî Desktop
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.side {
  width: 340px;
  background: var(--panel);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden;
  transition: transform .3s ease;
}

/* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
.side-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:32px;text-align:center;color:var(--muted);}
.se-icon{font-size:34px;opacity:.2;margin-bottom:4px;}
.side-empty h3{font-size:14px;font-weight:600;color:var(--text2);}
.side-empty p{font-size:12.5px;line-height:1.8;}

/* ‚îÄ‚îÄ Component panel ‚îÄ‚îÄ */
.comp-panel{display:none;flex-direction:column;flex:1;overflow:hidden;}
.comp-panel.show{display:flex;}
.comp-head{padding:16px 18px 12px;border-bottom:1px solid var(--border);flex-shrink:0;}
.cb{display:inline-flex;align-items:center;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;padding:2px 9px;border-radius:20px;margin-bottom:8px;border:1px solid;}
.cb.ctrl {border-color:rgba(79,158,255,.5);color:var(--accent);background:var(--accent-dim);}
.cb.power{border-color:rgba(255,107,53,.5);color:var(--orange);background:var(--orange-dim);}
.cb.safe {border-color:rgba(46,204,113,.5);color:var(--green);background:var(--green-dim);}
.comp-name{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;line-height:1.2;}
.comp-model{font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);margin-top:3px;}

/* Edit banner */
.edit-banner{display:none;align-items:center;gap:7px;padding:6px 18px;background:var(--yellow-dim);border-bottom:1px solid rgba(245,200,66,.2);font-size:11px;color:var(--yellow);font-weight:500;flex-shrink:0;}
.edit-banner.show{display:flex;}
.eb-dot{width:5px;height:5px;border-radius:50%;background:var(--yellow);animation:blink 1.2s ease-in-out infinite;}
.eb-save{margin-left:auto;padding:3px 10px;border-radius:4px;border:1px solid rgba(245,200,66,.4);background:transparent;color:var(--yellow);font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;transition:all .2s;}
.eb-save:hover{background:rgba(245,200,66,.2);}

/* Tabs */
.tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;}
.tab{flex:1;padding:9px 3px;text-align:center;font-size:10px;font-weight:600;letter-spacing:.2px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;user-select:none;}
.tab:hover{color:var(--text2);}
.tab.on{color:var(--accent);border-bottom-color:var(--accent);}

/* Tab body */
.tab-body{flex:1;overflow-y:auto;padding:16px 18px;display:flex;flex-direction:column;gap:14px;}
.fl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
.fv{font-size:13px;line-height:1.75;color:var(--text);}
.fv.card{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;}
.fv.hl{background:var(--accent-dim);border-left:2px solid var(--accent);padding:9px 12px;border-radius:0 5px 5px 0;}
.warn-box{background:var(--orange-dim);border:1px solid rgba(255,107,53,.3);border-radius:6px;padding:10px 12px;font-size:13px;line-height:1.7;color:#ffb59a;display:flex;gap:8px;}
.params-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.param-chip{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:9px 11px;}
.param-chip .pk{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-bottom:2px;}
.param-chip .pv{font-size:12px;font-weight:600;color:var(--text);}

[contenteditable="true"]{outline:none;border-bottom:1px dashed rgba(245,200,66,.6);cursor:text;padding-bottom:1px;min-width:20px;display:inline-block;}
[contenteditable="true"]:focus{background:rgba(245,200,66,.08);border-radius:3px;border-bottom-color:var(--yellow);}

/* Footer */
.side-footer{display:flex;align-items:center;gap:12px;padding:10px 18px;border-top:1px solid var(--border);flex-shrink:0;}
.legend{display:flex;gap:12px;flex:1;}
.leg{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted);}
.ldot{width:7px;height:7px;border-radius:50%;border:2px solid;}
.ldot.c{border-color:var(--accent);}.ldot.p{border-color:var(--orange);}.ldot.s{border-color:var(--green);}
.cbtn{padding:6px 12px;background:transparent;border:1px solid var(--border2);color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;border-radius:5px;transition:all .2s;white-space:nowrap;}
.cbtn:hover{border-color:var(--accent);color:var(--accent);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE BOTTOM SHEET
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media (max-width: 700px) {
  .header { padding: 0 10px; gap: 6px; }
  .logo { font-size: 14px; letter-spacing: 2px; }
  .project-input { max-width: 120px; font-size: 11px; }
  .hbtn { padding: 5px 8px; font-size: 9px; gap: 4px; }
  .hbtn span { display: none; } /* hide labels, show icons only on very small */

  .workspace { flex-direction: column; }

  /* Image takes full screen */
  .image-zone { flex: 1; min-height: 0; }
  .img-canvas img {
    max-height: calc(100dvh - 52px - 56px); /* leave room for bottom tab bar */
    width: 100%;
  }

  /* Side panel becomes bottom sheet */
  .side {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    width: 100%;
    height: 65dvh;
    border-left: none;
    border-top: 1px solid var(--border2);
    border-radius: 16px 16px 0 0;
    transform: translateY(100%);
    z-index: 50;
    box-shadow: 0 -8px 40px rgba(0,0,0,.6);
  }
  .side.open { transform: translateY(0); }

  /* Drag handle */
  .side::before {
    content: '';
    display: block;
    width: 36px; height: 4px;
    background: var(--border2);
    border-radius: 4px;
    margin: 10px auto 0;
    flex-shrink: 0;
  }

  /* Mobile close button ‚Äî always visible at bottom */
  .mobile-close-btn {
    display: flex;
    position: fixed;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 200;
    padding: 10px 28px;
    background: var(--panel2);
    border: 1px solid var(--border2);
    border-radius: 20px;
    color: var(--text2);
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,.5);
    transition: all .2s;
  }
  .mobile-close-btn:active { background: var(--border2); }

  .comp-head { padding: 12px 16px 10px; }
  .tab-body { padding: 12px 16px; }
  .tabs .tab { padding: 8px 2px; font-size: 9px; }
  .params-grid { grid-template-columns: 1fr 1fr; }
  .side-footer { padding: 8px 16px; }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE CLOSE BTN (hidden desktop)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.mobile-close-btn { display: none; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VIEW-ONLY BADGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.view-badge{display:none;position:fixed;top:10px;right:12px;padding:5px 12px;background:var(--green-dim);border:1px solid rgba(46,204,113,.4);color:var(--green);border-radius:20px;font-family:'DM Mono',monospace;font-size:10px;z-index:300;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   OVERLAYS / MODALS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(4px);padding:16px;}
.overlay.show{display:flex;}
.modal{background:var(--panel);border:1px solid var(--border2);border-radius:12px;padding:24px;box-shadow:0 24px 80px rgba(0,0,0,.8);display:flex;flex-direction:column;gap:14px;width:100%;max-height:90dvh;overflow-y:auto;}
.modal h3{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;letter-spacing:1px;}
.modal p{font-size:13px;color:var(--text2);line-height:1.7;}

/* GitHub modal */
.gh-modal{max-width:420px;}
.gh-modal h3{color:#c9d1d9;}
.field-lbl{font-size:11px;color:var(--text2);font-weight:500;margin-bottom:4px;display:block;}
.field-inp{width:100%;background:var(--panel2);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:8px 11px;transition:border-color .2s;}
.field-inp:focus{outline:none;border-color:var(--accent);}
.note{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--muted);line-height:1.7;}
.note code{color:var(--accent);font-family:'DM Mono',monospace;font-size:10px;}
.modal-btns{display:flex;gap:8px;}
.btn-cancel{flex:1;padding:9px;border:1px solid var(--border2);background:transparent;color:var(--muted);border-radius:6px;font-size:13px;cursor:pointer;transition:all .2s;}
.btn-cancel:hover{border-color:var(--red);color:var(--red);}
.btn-ok{flex:2;padding:9px;border:1px solid var(--accent);background:var(--accent-dim);color:var(--accent);border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-ok:hover{background:rgba(79,158,255,.26);}
.btn-ok.green{border-color:var(--green);background:var(--green-dim);color:var(--green);}
.btn-ok.green:hover{background:rgba(46,204,113,.22);}

/* New hotspot modal */
.hs-modal{max-width:400px;}
.hs-modal h3{color:var(--yellow);}
.form-inp{width:100%;background:var(--panel2);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:8px 11px;resize:none;transition:border-color .2s;}
.form-inp:focus{outline:none;border-color:var(--accent);}
.form-row{display:flex;gap:8px;}
.form-row>*{flex:1;}
.type-sel{display:flex;gap:6px;}
.ts{flex:1;padding:6px 4px;border-radius:6px;border:1px solid var(--border2);background:transparent;font-size:10px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--muted);text-align:center;}
.ts.sc{border-color:var(--accent);color:var(--accent);background:var(--accent-dim);}
.ts.sp{border-color:var(--orange);color:var(--orange);background:var(--orange-dim);}
.ts.ss{border-color:var(--green);color:var(--green);background:var(--green-dim);}

/* Share modal */
.share-modal{max-width:460px;}
.share-modal h3{color:var(--green);}
.url-row{display:flex;gap:8px;align-items:stretch;}
.url-box{flex:1;background:var(--panel2);border:1px solid var(--border2);border-radius:6px;padding:8px 11px;font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);word-break:break-all;overflow-y:auto;max-height:60px;}
.copy-btn{padding:8px 12px;border:1px solid var(--green);background:var(--green-dim);color:var(--green);border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;font-family:'DM Mono',monospace;white-space:nowrap;}
.copy-btn:hover{background:rgba(46,204,113,.22);}
.qr-section{display:flex;gap:16px;align-items:flex-start;}
.qr-wrap{background:#fff;border-radius:8px;padding:10px;flex-shrink:0;}
#qrcode canvas,#qrcode img{display:block;}
.qr-meta{flex:1;display:flex;flex-direction:column;gap:8px;}
.qr-meta h4{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;color:var(--text);}
.qr-meta p{font-size:12px;color:var(--text2);line-height:1.7;}
.print-btn{padding:7px 14px;border:1px solid var(--accent);background:var(--accent-dim);color:var(--accent);border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;font-family:'DM Mono',monospace;align-self:flex-start;}
.print-btn:hover{background:rgba(79,158,255,.26);}

/* Progress */
.prog-wrap{display:none;align-items:center;gap:10px;padding:10px 12px;background:var(--panel2);border:1px solid var(--border2);border-radius:6px;font-size:12px;color:var(--text2);}
.prog-wrap.show{display:flex;}
.prog-bar-bg{flex:1;height:3px;background:var(--border2);border-radius:3px;overflow:hidden;}
.prog-bar{height:100%;background:var(--accent);border-radius:3px;width:0%;transition:width .3s;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRINT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#printArea{display:none;position:fixed;inset:0;background:#fff;z-index:9999;align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:40px;}
#printArea .pa-title{font-family:'Rajdhani',sans-serif;font-size:26px;font-weight:700;color:#111;}
#printArea .pa-sub{font-size:13px;color:#555;}
#printArea .pa-url{font-family:monospace;font-size:10px;color:#333;word-break:break-all;max-width:360px;text-align:center;}
@media print{body>*:not(#printArea){display:none!important;}#printArea{display:flex!important;}}
</style>
</head>
<body>

<!-- PRINT AREA -->
<div id="printArea">
  <div class="pa-title" id="pTitle">Armario</div>
  <div class="pa-sub">Escanea para ver la gu√≠a interactiva de componentes</div>
  <div id="pQr" style="background:#fff;padding:8px;border-radius:4px;"></div>
  <div class="pa-url" id="pUrl"></div>
  <button onclick="closePrint()" style="margin-top:12px;padding:7px 18px;border:1px solid #ccc;border-radius:6px;cursor:pointer;font-size:13px;background:#f5f5f5;">‚úï Cerrar</button>
</div>

<!-- HEADER -->
<header class="header" id="appHeader">
  <div class="logo">CTRL<em>PANEL</em></div>
  <input class="project-input" id="projectName" type="text" value="Armario sin t√≠tulo" maxlength="60" placeholder="Nombre‚Ä¶">
  <div class="hspacer"></div>
  <button class="hbtn gh" id="btnGH" onclick="openGH()">
    <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
    <span id="ghBtnLabel">GITHUB</span>
  </button>
  <button class="hbtn" id="btnEdit" onclick="toggleEdit()">
    <div class="led"></div>EDICI√ìN
  </button>
  <button class="hbtn share" id="btnShare" onclick="openShare()" disabled>‚¨° QR</button>
</header>

<div class="view-badge" id="viewBadge">üëÅ SOLO LECTURA</div>

<!-- WORKSPACE -->
<div class="workspace">

  <div class="image-zone" id="imageZone">
    <div class="drop-zone" id="dropZone">
      <div class="dz-icon">üì∑</div>
      <h2>Foto del armario</h2>
      <p>Arrastra la imagen aqu√≠ o haz clic para seleccionarla</p>
      <label class="dz-btn">Seleccionar imagen
        <input type="file" accept="image/*" id="fileInput" style="display:none" onchange="loadImg(event)">
      </label>
    </div>
    <div class="img-canvas" id="imgCanvas">
      <img id="panelImg" alt="Armario">
    </div>
  </div>

  <!-- SIDE PANEL -->
  <div class="side" id="side">
    <div class="side-empty" id="sideEmpty">
      <div class="se-icon">‚ö°</div>
      <h3>Sin componente seleccionado</h3>
      <p id="sideHint">Toca un punto numerado para ver su informaci√≥n.<br><br>En <b>Modo Edici√≥n</b>, toca la imagen para a√±adir un punto nuevo.</p>
    </div>
    <div class="comp-panel" id="compPanel">
      <div class="comp-head" id="compHead"></div>
      <div class="edit-banner" id="editBanner">
        <div class="eb-dot"></div>Modo edici√≥n
        <button class="eb-save" onclick="saveComp()">üíæ GUARDAR</button>
      </div>
      <div class="tabs">
        <div class="tab on" onclick="setTab(0)">Funci√≥n</div>
        <div class="tab" onclick="setTab(1)">Marca</div>
        <div class="tab" onclick="setTab(2)">Uso&Reset</div>
        <div class="tab" onclick="setTab(3)">Params</div>
      </div>
      <div class="tab-body" id="tabBody"></div>
    </div>
    <div class="side-footer">
      <div class="legend">
        <div class="leg"><div class="ldot c"></div>Control</div>
        <div class="leg"><div class="ldot p"></div>Potencia</div>
        <div class="leg"><div class="ldot s"></div>Seguridad</div>
      </div>
      <button class="cbtn" id="closeBtn" onclick="closeComp()" style="display:none">‚úï Cerrar</button>
    </div>
  </div>

  <!-- Mobile close button (outside side panel) -->
  <button class="mobile-close-btn" id="mobileCloseBtn" onclick="closeComp()">‚úï Cerrar</button>
</div>

<!-- ‚ïê‚ïê GITHUB MODAL ‚ïê‚ïê -->
<div class="overlay" id="ghOverlay">
  <div class="modal gh-modal">
    <h3>‚¨° Configuraci√≥n GitHub</h3>
    <p>Las im√°genes y datos se guardar√°n en tu repositorio. La URL del QR ser√° ultracorta.</p>
    <div><label class="field-lbl">Usuario de GitHub</label><input class="field-inp" id="ghUser" placeholder="tu-usuario" type="text"></div>
    <div><label class="field-lbl">Repositorio (con GitHub Pages activo)</label><input class="field-inp" id="ghRepo" placeholder="mi-repo" type="text"></div>
    <div><label class="field-lbl">Carpeta para los archivos</label><input class="field-inp" id="ghFolder" placeholder="armarios" type="text" value="armarios"></div>
    <div><label class="field-lbl">Personal Access Token (classic ‚Äî scope: repo)</label><input class="field-inp" id="ghToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" type="password"></div>
    <div class="note">
      Crea el token en <code>GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)</code>.<br>
      Activa el scope <code>repo</code>. El token se guarda solo en tu navegador.
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeGH()">Cancelar</button>
      <button class="btn-ok green" onclick="saveGH()">‚úì Guardar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê NEW HOTSPOT MODAL ‚ïê‚ïê -->
<div class="overlay" id="hsOverlay">
  <div class="modal hs-modal">
    <h3>‚ú¶ Nuevo punto</h3>
    <div><label class="field-lbl">Nombre del componente</label><input class="form-inp" id="f_name" type="text" placeholder="Ej: Variador de frecuencia VF1"></div>
    <div>
      <label class="field-lbl">Tipo</label>
      <div class="type-sel">
        <button class="ts sc" onclick="selT('ctrl',this)">‚¨° Control</button>
        <button class="ts"    onclick="selT('power',this)">‚ö° Potencia</button>
        <button class="ts"    onclick="selT('safe',this)">üõ° Seguridad</button>
      </div>
    </div>
    <div><label class="field-lbl">Funci√≥n (lenguaje sencillo)</label><textarea class="form-inp" id="f_funcion" rows="3" placeholder="¬øPara qu√© sirve?"></textarea></div>
    <div class="form-row">
      <div><label class="field-lbl">Marca</label><input class="form-inp" id="f_marca" type="text" placeholder="Omron"></div>
      <div><label class="field-lbl">Modelo</label><input class="form-inp" id="f_modelo" type="text" placeholder="3G3M1"></div>
    </div>
    <div><label class="field-lbl">Diagn√≥stico</label><textarea class="form-inp" id="f_uso" rows="2" placeholder="¬øQu√© LEDs mirar? ¬øQu√© indica un error?"></textarea></div>
    <div><label class="field-lbl">Pasos para reset</label><input class="form-inp" id="f_reset" type="text" placeholder="Ej: Desbloquear seta ‚Üí RESET"></div>
    <div><label class="field-lbl">‚ö† Aviso de seguridad (opcional)</label><input class="form-inp" id="f_aviso" type="text" placeholder="Ej: 400VAC ‚Äî No manipular con tensi√≥n"></div>
    <div><label class="field-lbl">Par√°metros t√©cnicos <small style="color:var(--muted);font-weight:400">(Clave: Valor, separado por comas)</small></label><input class="form-inp" id="f_params" type="text" placeholder="Tensi√≥n: 400VAC, Potencia: 2.2kW"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="cancelHs()">Cancelar</button>
      <button class="btn-ok" onclick="confirmHs()">‚úì Crear punto</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SHARE / QR MODAL ‚ïê‚ïê -->
<div class="overlay" id="shareOverlay">
  <div class="modal share-modal">
    <h3>‚¨° Enlace cliente + QR</h3>
    <div class="prog-wrap" id="progWrap">
      <span id="progMsg">Subiendo a GitHub‚Ä¶</span>
      <div class="prog-bar-bg"><div class="prog-bar" id="progBar"></div></div>
    </div>
    <div id="shareContent" style="display:none;flex-direction:column;gap:14px;">
      <p>Enlace de <b>solo lectura</b> para tu cliente. La imagen y los datos est√°n en GitHub.</p>
      <div class="url-row">
        <div class="url-box" id="shareUrl">‚Äî</div>
        <button class="copy-btn" onclick="copyUrl()">COPIAR</button>
      </div>
      <div class="qr-section">
        <div class="qr-wrap"><div id="qrcode"></div></div>
        <div class="qr-meta">
          <h4>QR listo para imprimir</h4>
          <p>P√©galo en la documentaci√≥n o en la puerta del armario.</p>
          <button class="print-btn" onclick="printQR()">üñ® Imprimir QR</button>
        </div>
      </div>
      <div class="note">‚úÖ Imagen + datos en GitHub ¬∑ URL corta ¬∑ QR escaneable con cualquier m√≥vil</div>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeShare()">Cerrar</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = { projectName:'Armario sin t√≠tulo', imageUrl:null, hotspots:[] };
let GH = { user:'', repo:'', folder:'armarios', token:'' };
let editMode=false, viewOnly=false;
let curId=null, curTab=0, pendPos=null, selType_='ctrl', nextId=1;
let shareUrl_='';
let pendingFile=null;
const isMobile = () => window.innerWidth <= 700;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load', () => {
  // Restore GH config
  try { const s=localStorage.getItem('cp_gh'); if(s){GH=JSON.parse(s);updateGHBtn();} } catch(e){}

  // View-only mode via ?id=xxx
  const params = new URLSearchParams(location.search);
  const armId = params.get('id');
  if (armId) {
    viewOnly = true;
    loadFromGitHub(armId);
    return;
  }

  setupDrop();
  document.addEventListener('keydown', e => {
    if(e.key==='Escape'){ cancelHs(); closeShare(); closeGH(); }
  });
});

async function loadFromGitHub(id) {
  document.getElementById('appHeader').style.display='none';
  document.getElementById('viewBadge').style.display='block';
  document.getElementById('sideHint').innerHTML='Toca un punto numerado para ver la informaci√≥n del componente.';

  try {
    // Fetch the JSON data file from GitHub (raw URL, public)
    const jsonUrl = `https://raw.githubusercontent.com/${location.hostname.split('.')[0]}/${location.hostname.split('.')[0]}.github.io/main/${GH.folder || 'armarios'}/${id}.json`;
    // Fallback: try to get config from localStorage for the base path
    let base = localStorage.getItem('cp_gh_pages_base') || '';
    const dataUrl = base ? `${base}/${id}.json` : `${location.origin}/${id}.json`;

    const res = await fetch(dataUrl);
    if(!res.ok) throw new Error('No se pudo cargar el armario');
    S = await res.json();
    document.title = S.projectName + ' ‚Äî Vista cliente';
    loadImageFromUrl(S.imageUrl);
    renderHotspots();
  } catch(e) {
    document.getElementById('sideEmpty').querySelector('h3').textContent = 'Error al cargar';
    document.getElementById('sideHint').textContent = 'No se pudo cargar la informaci√≥n del armario. Comprueba el enlace.';
    console.error(e);
  }
}

function setupDrop() {
  const dz = document.getElementById('dropZone');
  dz.addEventListener('dragover', e=>{e.preventDefault();dz.classList.add('over');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
  dz.addEventListener('drop', e=>{
    e.preventDefault(); dz.classList.remove('over');
    const f=e.dataTransfer.files[0];
    if(f&&f.type.startsWith('image/')) handleFile(f);
  });
  dz.addEventListener('click', e=>{
    if(e.target.tagName!=='INPUT') document.getElementById('fileInput').click();
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GITHUB CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openGH(){
  document.getElementById('ghUser').value=GH.user;
  document.getElementById('ghRepo').value=GH.repo;
  document.getElementById('ghFolder').value=GH.folder||'armarios';
  document.getElementById('ghToken').value=GH.token;
  document.getElementById('ghOverlay').classList.add('show');
}
function closeGH(){ document.getElementById('ghOverlay').classList.remove('show'); }
function saveGH(){
  GH.user=document.getElementById('ghUser').value.trim();
  GH.repo=document.getElementById('ghRepo').value.trim();
  GH.folder=document.getElementById('ghFolder').value.trim()||'armarios';
  GH.token=document.getElementById('ghToken').value.trim();
  if(!GH.user||!GH.repo||!GH.token){alert('Rellena usuario, repositorio y token.');return;}
  // Save the pages base URL for view-only loading
  const pagesBase=`https://raw.githubusercontent.com/${GH.user}/${GH.repo}/main/${GH.folder}`;
  localStorage.setItem('cp_gh_pages_base', pagesBase);
  localStorage.setItem('cp_gh', JSON.stringify(GH));
  updateGHBtn();
  closeGH();
  updateShareBtn();
}
function updateGHBtn(){
  const btn=document.getElementById('btnGH');
  const lbl=document.getElementById('ghBtnLabel');
  if(GH.user&&GH.repo&&GH.token){
    btn.classList.add('ok');
    lbl.textContent=`${GH.user}/${GH.repo} ‚úì`;
  } else {
    btn.classList.remove('ok');
    lbl.textContent='GITHUB';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadImg(e){ const f=e.target.files[0]; if(f) handleFile(f); }
function handleFile(file){
  pendingFile=file;
  const r=new FileReader();
  r.onload=ev=>{loadImageFromUrl(ev.target.result); updateShareBtn();};
  r.readAsDataURL(file);
}
function loadImageFromUrl(url){
  document.getElementById('dropZone').style.display='none';
  document.getElementById('imgCanvas').style.display='block';
  document.getElementById('panelImg').src=url;
  if(!viewOnly) S.imageUrl=null; // will be updated after GH upload
}
function updateShareBtn(){
  const ok = (pendingFile||S.imageUrl) && GH.token;
  const btn=document.getElementById('btnShare');
  btn.disabled=!ok;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EDIT MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleEdit(){
  if(!document.getElementById('panelImg').getAttribute('src') || document.getElementById('panelImg').getAttribute('src')===window.location.href){
    alert('Primero sube una imagen.'); return;
  }
  editMode=!editMode;
  const btn=document.getElementById('btnEdit');
  btn.classList.toggle('edit-on',editMode);
  document.body.classList.toggle('edit-mode',editMode);
  document.getElementById('imgCanvas').classList.toggle('crosshair',editMode);
  if(curId!==null) document.getElementById('editBanner').classList.toggle('show',editMode);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLICK ON IMAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('imgCanvas').addEventListener('click', e=>{
  if(!editMode||viewOnly) return;
  if(e.target.closest('.hs')) return;
  const img=document.getElementById('panelImg');
  const rect=img.getBoundingClientRect();
  pendPos={
    x:parseFloat(((e.clientX-rect.left)/rect.width*100).toFixed(2)),
    y:parseFloat(((e.clientY-rect.top)/rect.height*100).toFixed(2))
  };
  openHsForm();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HOTSPOT FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openHsForm(){
  ['f_name','f_funcion','f_marca','f_modelo','f_uso','f_reset','f_aviso','f_params'].forEach(id=>document.getElementById(id).value='');
  selType_='ctrl';
  document.querySelectorAll('.ts').forEach(b=>b.className='ts');
  document.querySelectorAll('.ts')[0].classList.add('sc');
  document.getElementById('hsOverlay').classList.add('show');
  setTimeout(()=>document.getElementById('f_name').focus(),80);
}
function cancelHs(){ document.getElementById('hsOverlay').classList.remove('show'); pendPos=null; }
function selT(type,btn){
  selType_=type;
  document.querySelectorAll('.ts').forEach(b=>b.className='ts');
  btn.classList.add(type==='ctrl'?'sc':type==='power'?'sp':'ss');
}
function parseParams(str){
  if(!str.trim()) return [{k:'Tensi√≥n',v:'‚Äî'},{k:'Corriente',v:'‚Äî'},{k:'Potencia',v:'‚Äî'},{k:'Norma',v:'‚Äî'}];
  return str.split(',').map(s=>{const[k,...r]=s.split(':');return{k:k?.trim()||'‚Äî',v:r.join(':').trim()||'‚Äî'};});
}
function confirmHs(){
  const lbls={ctrl:'CONTROL',power:'POTENCIA',safe:'SEGURIDAD'};
  const hs={
    id:nextId++, x:pendPos.x, y:pendPos.y,
    tipo:selType_, tipoLabel:lbls[selType_],
    name:   document.getElementById('f_name').value.trim()||'Componente',
    marca:  document.getElementById('f_marca').value.trim()||'‚Äî',
    modelo: document.getElementById('f_modelo').value.trim()||'‚Äî',
    funcion:document.getElementById('f_funcion').value.trim()||'‚Äî',
    uso:    document.getElementById('f_uso').value.trim()||'‚Äî',
    reset:  document.getElementById('f_reset').value.trim()||'‚Äî',
    aviso:  document.getElementById('f_aviso').value.trim()||null,
    params: parseParams(document.getElementById('f_params').value)
  };
  S.hotspots.push(hs);
  cancelHs();
  addHsEl(hs);
  showComp(hs.id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HOTSPOT ELEMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHotspots(){ document.querySelectorAll('.hs').forEach(h=>h.remove()); S.hotspots.forEach(addHsEl); }
function addHsEl(hs){
  const c=document.getElementById('imgCanvas');
  const el=document.createElement('div');
  el.className=`hs ${hs.tipo}`; el.id='hs_'+hs.id; el.dataset.id=hs.id;
  el.style.left=hs.x+'%'; el.style.top=hs.y+'%';
  el.innerHTML=`<div class="hsr">${hs.id}</div><div class="hs-tip">${hs.name}</div><div class="hs-del">‚úï</div>`;
  el.querySelector('.hsr').addEventListener('click',()=>showComp(hs.id));
  el.querySelector('.hs-del').addEventListener('click',e=>{e.stopPropagation();delHs(hs.id);});
  c.appendChild(el);
}
function delHs(id){
  if(!confirm('¬øEliminar este punto?')) return;
  S.hotspots=S.hotspots.filter(h=>h.id!==id);
  document.getElementById('hs_'+id)?.remove();
  if(curId===id) closeComp();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHOW COMPONENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showComp(id){
  curId=id; curTab=0;
  const hs=S.hotspots.find(h=>h.id===id);
  if(!hs) return;
  document.querySelectorAll('.hs').forEach(h=>h.classList.remove('active'));
  document.getElementById('hs_'+id)?.classList.add('active');
  document.getElementById('compHead').innerHTML=`
    <div class="cb ${hs.tipo}">${hs.tipoLabel}</div>
    <div class="comp-name">${hs.name}</div>
    <div class="comp-model">${hs.marca} ¬∑ ${hs.modelo}</div>`;
  document.getElementById('editBanner').classList.toggle('show',editMode&&!viewOnly);
  renderTab(hs);
  document.getElementById('sideEmpty').style.display='none';
  document.getElementById('compPanel').classList.add('show');
  document.getElementById('closeBtn').style.display='block';

  // Mobile: open bottom sheet
  if(isMobile()){
    document.getElementById('side').classList.add('open');
    document.getElementById('mobileCloseBtn').style.display='flex';
  }
}

function renderTab(hs){
  const ed=(editMode&&!viewOnly)?'contenteditable="true"':'';
  const tabs=[
    `<div class="fl">¬øPara qu√© sirve?</div><div class="fv" ${ed}>${hs.funcion}</div>
     ${hs.aviso?`<div class="warn-box"><span>‚ö†Ô∏è</span><span ${ed}>${hs.aviso}</span></div>`:''}`,
    `<div class="fl">Fabricante</div><div class="fv card" ${ed}>${hs.marca}</div>
     <div style="height:2px"></div><div class="fl">Referencia / Ubicaci√≥n</div><div class="fv card" ${ed}>${hs.modelo}</div>`,
    `<div class="fl">C√≥mo identificar un problema</div><div class="fv hl" ${ed}>${hs.uso}</div>
     <div style="height:2px"></div><div class="fl">Pasos para reset</div><div class="fv card" ${ed}>${hs.reset}</div>`,
    `<div class="params-grid">${hs.params.map(p=>`<div class="param-chip"><div class="pk">${p.k}</div><div class="pv" ${ed}>${p.v}</div></div>`).join('')}</div>`
  ];
  document.getElementById('tabBody').innerHTML=tabs[curTab];
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('on',i===curTab));
}

function setTab(i){ curTab=i; const hs=S.hotspots.find(h=>h.id===curId); if(hs) renderTab(hs); }

function closeComp(){
  document.querySelectorAll('.hs').forEach(h=>h.classList.remove('active'));
  document.getElementById('sideEmpty').style.display='';
  document.getElementById('compPanel').classList.remove('show');
  document.getElementById('editBanner').classList.remove('show');
  document.getElementById('closeBtn').style.display='none';
  curId=null;
  // Mobile: close bottom sheet
  document.getElementById('side').classList.remove('open');
  document.getElementById('mobileCloseBtn').style.display='none';
}

function saveComp(){
  const hs=S.hotspots.find(h=>h.id===curId); if(!hs) return;
  const ce=document.getElementById('tabBody').querySelectorAll('[contenteditable]');
  if(curTab===0){if(ce[0])hs.funcion=ce[0].innerText.trim();if(ce[1]&&hs.aviso)hs.aviso=ce[1].innerText.trim();}
  else if(curTab===1){if(ce[0])hs.marca=ce[0].innerText.trim();if(ce[1])hs.modelo=ce[1].innerText.trim();}
  else if(curTab===2){if(ce[0])hs.uso=ce[0].innerText.trim();if(ce[1])hs.reset=ce[1].innerText.trim();}
  else if(curTab===3){ce.forEach((el,i)=>{if(hs.params[i])hs.params[i].v=el.innerText.trim();});}
  document.getElementById('compHead').innerHTML=`
    <div class="cb ${hs.tipo}">${hs.tipoLabel}</div>
    <div class="comp-name">${hs.name}</div>
    <div class="comp-model">${hs.marca} ¬∑ ${hs.modelo}</div>`;
  const btn=document.querySelector('.eb-save');
  btn.textContent='‚úì OK'; btn.style.color='var(--green)';
  setTimeout(()=>{btn.textContent='üíæ GUARDAR';btn.style.color='';},2000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GITHUB UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function uploadFile(path, content, isBase64=false){
  // Check if file exists (to get SHA for update)
  let sha = undefined;
  try {
    const check=await fetch(`https://api.github.com/repos/${GH.user}/${GH.repo}/contents/${path}`,{
      headers:{'Authorization':`token ${GH.token}`,'Accept':'application/vnd.github.v3+json'}
    });
    if(check.ok){ const d=await check.json(); sha=d.sha; }
  } catch(e){}

  const body={
    message:`CTRLPANEL: ${S.projectName}`,
    content: isBase64 ? content : btoa(unescape(encodeURIComponent(content)))
  };
  if(sha) body.sha=sha;

  const res=await fetch(`https://api.github.com/repos/${GH.user}/${GH.repo}/contents/${path}`,{
    method:'PUT',
    headers:{'Authorization':`token ${GH.token}`,'Content-Type':'application/json','Accept':'application/vnd.github.v3+json'},
    body:JSON.stringify(body)
  });
  if(!res.ok){ const e=await res.json(); throw new Error(e.message||'GitHub error'); }
  return await res.json();
}

async function compressImg(file, maxPx, q){
  return new Promise(resolve=>{
    const img=new Image(); const r=new FileReader();
    r.onload=e=>{
      img.onload=()=>{
        const cv=document.createElement('canvas');
        let w=img.width,h=img.height;
        if(w>maxPx){h=Math.round(h*maxPx/w);w=maxPx;}
        if(h>maxPx){w=Math.round(w*maxPx/h);h=maxPx;}
        cv.width=w;cv.height=h;
        cv.getContext('2d').drawImage(img,0,0,w,h);
        resolve(cv.toDataURL('image/jpeg',q));
      };
      img.src=e.target.result;
    };
    r.readAsDataURL(file);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHARE + QR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openShare(){
  if(!GH.user||!GH.token){alert('Configura primero GitHub.');return;}
  if(!pendingFile&&!S.imageUrl){alert('Sube una imagen primero.');return;}

  S.projectName=document.getElementById('projectName').value||'Armario';

  document.getElementById('shareOverlay').classList.add('show');
  document.getElementById('shareContent').style.display='none';
  const pw=document.getElementById('progWrap');
  const pb=document.getElementById('progBar');
  const pm=document.getElementById('progMsg');
  pw.classList.add('show'); pb.style.width='0%'; pb.style.background='var(--accent)';

  try {
    // Generate unique ID for this panel
    const armId='armario_'+Date.now();

    // 1. Upload image if new file selected
    if(pendingFile){
      pm.textContent='Comprimiendo imagen‚Ä¶'; pb.style.width='15%';
      const compressed=await compressImg(pendingFile,1400,0.82);
      const imgBase64=compressed.split(',')[1];

      pm.textContent='Subiendo imagen a GitHub‚Ä¶'; pb.style.width='35%';
      await uploadFile(`${GH.folder}/${armId}.jpg`, imgBase64, true);

      S.imageUrl=`https://raw.githubusercontent.com/${GH.user}/${GH.repo}/main/${GH.folder}/${armId}.jpg`;
      pendingFile=null;
    }

    // 2. Upload JSON data
    pm.textContent='Guardando datos‚Ä¶'; pb.style.width='70%';
    const jsonStr=JSON.stringify(S, null, 2);
    await uploadFile(`${GH.folder}/${armId}.json`, jsonStr, false);

    pb.style.width='100%';
    pm.textContent='‚úì Subido correctamente';

    // 3. Build SHORT URL
    // GitHub Pages URL: https://USER.github.io/REPO/?id=armId
    const pagesUrl=`https://${GH.user}.github.io/${GH.repo}/?id=${armId}`;
    shareUrl_=pagesUrl;

    document.getElementById('shareUrl').textContent=pagesUrl;

    await new Promise(r=>setTimeout(r,400));

    // 4. Generate QR
    document.getElementById('qrcode').innerHTML='';
    new QRCode(document.getElementById('qrcode'),{
      text:pagesUrl, width:150, height:150,
      colorDark:'#000000', colorLight:'#ffffff',
      correctLevel:QRCode.CorrectLevel.M
    });

    pw.classList.remove('show');
    document.getElementById('shareContent').style.display='flex';

  } catch(err){
    pm.textContent='‚ùå Error: '+err.message;
    pb.style.background='var(--red)';
    console.error(err);
  }
}

function closeShare(){ document.getElementById('shareOverlay').classList.remove('show'); document.getElementById('progBar').style.background=''; }

function copyUrl(){
  navigator.clipboard.writeText(shareUrl_).then(()=>{
    const btn=document.querySelector('.copy-btn');
    btn.textContent='‚úì COPIADO'; btn.style.background='rgba(46,204,113,.3)';
    setTimeout(()=>{btn.textContent='COPIAR';btn.style.background='';},2200);
  });
}

function printQR(){
  document.getElementById('pTitle').textContent=S.projectName;
  document.getElementById('pUrl').textContent=shareUrl_;
  const pq=document.getElementById('pQr'); pq.innerHTML='';
  new QRCode(pq,{text:shareUrl_,width:220,height:220,colorDark:'#000',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.M});
  setTimeout(()=>{document.getElementById('printArea').style.display='flex';window.print();},250);
}
function closePrint(){ document.getElementById('printArea').style.display='none'; }
</script>
</body>
</html>
