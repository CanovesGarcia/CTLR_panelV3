<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CTRLPANEL â€” Armario Interactivo</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=DM+Mono:wght@400;500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root {
  --bg: #0b0d13;
  --panel: #11141d;
  --panel2: #171b27;
  --panel3: #1d2132;
  --border: #1e2235;
  --border2: #2a2f47;
  --accent: #4f9eff;
  --accent-dim: rgba(79,158,255,0.13);
  --accent-glow: rgba(79,158,255,0.28);
  --orange: #ff6b35;
  --orange-dim: rgba(255,107,53,0.13);
  --green: #2ecc71;
  --green-dim: rgba(46,204,113,0.11);
  --yellow: #f5c842;
  --yellow-dim: rgba(245,200,66,0.11);
  --red: #ff4757;
  --red-dim: rgba(255,71,87,0.13);
  --text: #dde1f0;
  --text2: #8b93ad;
  --muted: #454d6a;
  --r: 8px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
header{height:52px;display:flex;align-items:center;padding:0 18px;gap:10px;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0;z-index:200;}
.logo{font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:700;letter-spacing:3px;color:var(--accent);text-transform:uppercase;white-space:nowrap;}
.logo em{color:var(--text2);font-style:normal;font-weight:500;}
.project-input{font-size:13px;color:var(--text2);padding:4px 10px;border:1px solid var(--border2);border-radius:4px;background:var(--panel2);min-width:160px;font-family:'DM Mono',monospace;letter-spacing:0.5px;transition:border-color .2s;}
.project-input:focus{outline:none;border-color:var(--accent);color:var(--text);}
.spacer{flex:1;}
.hbtn{display:flex;align-items:center;gap:6px;padding:6px 13px;border-radius:6px;border:1px solid var(--border2);background:transparent;color:var(--text2);font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.8px;cursor:pointer;transition:all .2s;white-space:nowrap;}
.hbtn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim);}
.hbtn.edit-on{border-color:var(--yellow);color:var(--yellow);background:var(--yellow-dim);}
.hbtn.gb{border-color:var(--border2);}
.hbtn.gb:hover{border-color:#6e7681;color:#c9d1d9;background:rgba(110,118,129,.15);}
.hbtn.gb.configured{border-color:var(--green);color:var(--green);background:var(--green-dim);}
.hbtn.share-btn{border-color:var(--green);color:var(--green);background:var(--green-dim);}
.hbtn.share-btn:hover{background:rgba(46,204,113,.22);}
.led{width:7px;height:7px;border-radius:50%;background:var(--muted);transition:background .2s;}
.hbtn.edit-on .led{background:var(--yellow);animation:blink 1.2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
.workspace{display:flex;flex:1;overflow:hidden;}

/* â”€â”€â”€ IMAGE ZONE â”€â”€â”€ */
.image-zone{flex:1;background:#07080e;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;}
.drop-zone{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;width:calc(100% - 64px);height:calc(100% - 64px);border:2px dashed var(--border2);border-radius:14px;cursor:pointer;transition:all .25s;color:var(--muted);text-align:center;padding:40px;}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--accent);background:var(--accent-dim);color:var(--accent);}
.dz-icon{font-size:48px;opacity:.35;}
.drop-zone h2{font-family:'Rajdhani',sans-serif;font-size:21px;font-weight:700;letter-spacing:1px;}
.drop-zone p{font-size:13px;line-height:1.7;max-width:260px;}
.dz-btn{padding:9px 22px;background:var(--accent-dim);border:1px solid var(--accent);color:var(--accent);border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-block;}
.dz-btn:hover{background:rgba(79,158,255,.28);}

.img-canvas{position:relative;display:none;user-select:none;}
.img-canvas img{max-height:calc(100vh - 52px);max-width:100%;display:block;filter:brightness(.82);}
.img-canvas.crosshair{cursor:crosshair!important;}

/* â”€â”€â”€ HOTSPOTS â”€â”€â”€ */
.hs{position:absolute;width:34px;height:34px;transform:translate(-50%,-50%);cursor:pointer;z-index:20;}
.hs-ring{width:34px;height:34px;border-radius:50%;border:2px solid var(--accent);background:rgba(79,158,255,.18);display:flex;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;font-weight:700;font-size:13px;color:var(--accent);transition:transform .2s,box-shadow .2s;animation:rp 3s ease-in-out infinite;}
.hs.power .hs-ring{border-color:var(--orange);background:var(--orange-dim);color:var(--orange);animation:rpo 3s ease-in-out infinite;}
.hs.safe  .hs-ring{border-color:var(--green);background:var(--green-dim);color:var(--green);animation:rpg 3s ease-in-out infinite;}
.hs:hover .hs-ring,.hs.active .hs-ring{transform:scale(1.25);box-shadow:0 0 26px var(--accent-glow);}
.hs.power:hover .hs-ring,.hs.power.active .hs-ring{box-shadow:0 0 26px rgba(255,107,53,.4);}
.hs.safe:hover  .hs-ring,.hs.safe.active  .hs-ring {box-shadow:0 0 26px rgba(46,204,113,.35);}
@keyframes rp {0%,100%{box-shadow:0 0 0 0 rgba(79,158,255,.45)}60%{box-shadow:0 0 0 10px rgba(79,158,255,0)}}
@keyframes rpo{0%,100%{box-shadow:0 0 0 0 rgba(255,107,53,.45)}60%{box-shadow:0 0 0 10px rgba(255,107,53,0)}}
@keyframes rpg{0%,100%{box-shadow:0 0 0 0 rgba(46,204,113,.45)}60%{box-shadow:0 0 0 10px rgba(46,204,113,0)}}
.hs-tip{position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border2);color:var(--text);font-size:12px;font-weight:500;padding:5px 12px;white-space:nowrap;border-radius:5px;opacity:0;pointer-events:none;transition:opacity .15s;box-shadow:0 4px 20px rgba(0,0,0,.6);}
.hs:hover .hs-tip{opacity:1;}
.hs-del{display:none;position:absolute;top:-6px;right:-6px;width:17px;height:17px;border-radius:50%;background:var(--red);color:#fff;font-size:9px;align-items:center;justify-content:center;cursor:pointer;z-index:30;font-weight:700;}
.edit-mode-on .hs-del{display:flex;}

/* â”€â”€â”€ SIDE â”€â”€â”€ */
.side{width:358px;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.side-empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:36px;text-align:center;color:var(--muted);}
.se-icon{font-size:36px;opacity:.2;margin-bottom:6px;}
.side-empty h3{font-size:14px;font-weight:600;color:var(--text2);}
.side-empty p{font-size:12.5px;line-height:1.8;}
.comp-panel{display:none;flex-direction:column;flex:1;overflow:hidden;}
.comp-panel.show{display:flex;}
.comp-head{padding:18px 20px 14px;border-bottom:1px solid var(--border);flex-shrink:0;}
.comp-badge{display:inline-flex;align-items:center;gap:5px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px;padding:3px 10px;border-radius:20px;margin-bottom:9px;border:1px solid;}
.cb-ctrl {border-color:rgba(79,158,255,.5);color:var(--accent);background:var(--accent-dim);}
.cb-power{border-color:rgba(255,107,53,.5);color:var(--orange);background:var(--orange-dim);}
.cb-safe {border-color:rgba(46,204,113,.5);color:var(--green);background:var(--green-dim);}
.comp-name-h{font-family:'Rajdhani',sans-serif;font-size:21px;font-weight:700;line-height:1.2;}
.comp-model-h{font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);margin-top:4px;}
.edit-banner{display:none;align-items:center;gap:8px;padding:7px 20px;background:var(--yellow-dim);border-bottom:1px solid rgba(245,200,66,.22);font-size:12px;color:var(--yellow);font-weight:500;flex-shrink:0;}
.edit-banner.show{display:flex;}
.eb-dot{width:6px;height:6px;border-radius:50%;background:var(--yellow);animation:blink 1.2s ease-in-out infinite;}
.eb-save{margin-left:auto;padding:3px 11px;border-radius:4px;border:1px solid rgba(245,200,66,.4);background:transparent;color:var(--yellow);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;cursor:pointer;transition:all .2s;}
.eb-save:hover{background:rgba(245,200,66,.2);}
.tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;}
.tab{flex:1;padding:10px 4px;text-align:center;font-size:11px;font-weight:600;letter-spacing:.3px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;user-select:none;}
.tab:hover{color:var(--text2);}
.tab.on{color:var(--accent);border-bottom-color:var(--accent);}
.tab-body{flex:1;overflow-y:auto;padding:18px 20px;display:flex;flex-direction:column;gap:16px;}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.fblock .fl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.fblock .fv{font-size:13px;line-height:1.75;color:var(--text);}
.fblock .fv.card{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:11px 13px;}
.fblock .fv.hl{background:var(--accent-dim);border-left:2px solid var(--accent);padding:10px 13px;border-radius:0 5px 5px 0;}
.warn-box{background:var(--orange-dim);border:1px solid rgba(255,107,53,.3);border-radius:6px;padding:11px 13px;font-size:13px;line-height:1.7;color:#ffb59a;display:flex;gap:9px;}
.params-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.param-chip{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;}
.param-chip .pk{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:3px;}
.param-chip .pv{font-size:13px;font-weight:600;color:var(--text);}
[contenteditable="true"]{outline:none;border-bottom:1px dashed rgba(245,200,66,.6);cursor:text;padding-bottom:1px;min-width:20px;display:inline-block;transition:background .15s;}
[contenteditable="true"]:focus{background:rgba(245,200,66,.08);border-radius:3px;border-bottom-color:var(--yellow);}
.close-row{padding:10px 20px;border-top:1px solid var(--border);flex-shrink:0;}
.cbtn{width:100%;padding:9px;background:transparent;border:1px solid var(--border2);color:var(--muted);font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;cursor:pointer;border-radius:6px;transition:all .2s;}
.cbtn:hover{border-color:var(--accent);color:var(--accent);}
.legend{display:flex;gap:14px;padding:10px 20px;border-top:1px solid var(--border);flex-shrink:0;}
.leg{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted);}
.ldot{width:8px;height:8px;border-radius:50%;border:2px solid;}
.ldot.c{border-color:var(--accent);}.ldot.p{border-color:var(--orange);}.ldot.s{border-color:var(--green);}

/* â”€â”€â”€ VIEW BADGE â”€â”€â”€ */
.view-badge{display:none;position:fixed;top:14px;right:20px;padding:6px 14px;background:var(--green-dim);border:1px solid rgba(46,204,113,.4);color:var(--green);border-radius:20px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;z-index:300;}

/* â”€â”€â”€ MODALS â”€â”€â”€ */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.overlay.show{display:flex;}
.modal{background:var(--panel);border:1px solid var(--border2);border-radius:12px;padding:28px;box-shadow:0 24px 80px rgba(0,0,0,.7);display:flex;flex-direction:column;gap:16px;}

/* GitHub config modal */
.gh-modal{width:440px;}
.gh-modal h3{font-family:'Rajdhani',sans-serif;font-size:19px;font-weight:700;color:#c9d1d9;letter-spacing:1px;}
.gh-modal p{font-size:13px;color:var(--text2);line-height:1.7;}
.field-lbl{font-size:12px;color:var(--text2);font-weight:500;margin-bottom:5px;display:block;}
.field-inp{width:100%;background:var(--panel2);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:9px 12px;transition:border-color .2s;}
.field-inp:focus{outline:none;border-color:var(--accent);}
.gh-note{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:11px 13px;font-size:12px;color:var(--muted);line-height:1.7;}
.gh-note code{color:var(--accent);font-family:'DM Mono',monospace;font-size:11px;}
.modal-btns{display:flex;gap:10px;}
.btn-cancel{flex:1;padding:10px;border:1px solid var(--border2);background:transparent;color:var(--muted);border-radius:6px;font-size:13px;cursor:pointer;transition:all .2s;}
.btn-cancel:hover{border-color:var(--red);color:var(--red);}
.btn-ok{flex:2;padding:10px;border:1px solid var(--accent);background:var(--accent-dim);color:var(--accent);border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-ok:hover{background:rgba(79,158,255,.28);}
.btn-ok.green{border-color:var(--green);background:var(--green-dim);color:var(--green);}
.btn-ok.green:hover{background:rgba(46,204,113,.24);}

/* New hotspot form */
.hs-modal{width:400px;}
.hs-modal h3{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;color:var(--yellow);letter-spacing:1px;}
.form-inp{width:100%;background:var(--panel2);border:1px solid var(--border2);border-radius:6px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:9px 12px;transition:border-color .2s;resize:none;}
.form-inp:focus{outline:none;border-color:var(--accent);}
.form-row{display:flex;gap:10px;}
.form-row>*{flex:1;}
.type-sel{display:flex;gap:8px;}
.ts{flex:1;padding:7px 4px;border-radius:6px;border:1px solid var(--border2);background:transparent;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;color:var(--muted);text-align:center;}
.ts.s-ctrl {border-color:var(--accent);color:var(--accent);background:var(--accent-dim);}
.ts.s-power{border-color:var(--orange);color:var(--orange);background:var(--orange-dim);}
.ts.s-safe {border-color:var(--green);color:var(--green);background:var(--green-dim);}

/* Share / QR modal */
.share-modal{width:480px;}
.share-modal h3{font-family:'Rajdhani',sans-serif;font-size:19px;font-weight:700;color:var(--green);letter-spacing:1px;}
.share-modal p{font-size:13px;color:var(--text2);line-height:1.7;}
.url-row{display:flex;gap:8px;}
.url-box{flex:1;background:var(--panel2);border:1px solid var(--border2);border-radius:6px;padding:9px 12px;font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);word-break:break-all;max-height:68px;overflow-y:auto;}
.copy-btn{padding:9px 14px;border:1px solid var(--green);background:var(--green-dim);color:var(--green);border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .2s;font-family:'DM Mono',monospace;}
.copy-btn:hover{background:rgba(46,204,113,.24);}

/* QR section */
.qr-section{display:flex;gap:20px;align-items:flex-start;}
.qr-wrap{background:#fff;border-radius:8px;padding:12px;flex-shrink:0;}
#qrcode canvas,#qrcode img{display:block;}
.qr-info{flex:1;display:flex;flex-direction:column;gap:10px;}
.qr-info h4{font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:600;color:var(--text);}
.qr-info p{font-size:12px;color:var(--text2);line-height:1.7;}
.print-btn{padding:8px 16px;border:1px solid var(--accent);background:var(--accent-dim);color:var(--accent);border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;font-family:'DM Mono',monospace;letter-spacing:.5px;}
.print-btn:hover{background:rgba(79,158,255,.28);}

/* Upload progress */
.upload-progress{display:none;align-items:center;gap:12px;padding:11px 13px;background:var(--panel2);border:1px solid var(--border2);border-radius:6px;font-size:13px;color:var(--text2);}
.upload-progress.show{display:flex;}
.progress-bar-wrap{flex:1;height:4px;background:var(--border2);border-radius:4px;overflow:hidden;}
.progress-bar{height:100%;background:var(--accent);border-radius:4px;width:0%;transition:width .3s;}

/* Step indicator */
.steps{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);}
.step{display:flex;align-items:center;gap:5px;}
.step-dot{width:20px;height:20px;border-radius:50%;border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;font-family:'DM Mono',monospace;}
.step.done .step-dot{background:var(--green);border-color:var(--green);color:#000;}
.step.active .step-dot{background:var(--accent);border-color:var(--accent);color:#000;}
.step-line{width:20px;height:1px;background:var(--border2);}

@media print {
  body > *:not(#printArea) { display: none !important; }
  #printArea { display: flex !important; }
}
#printArea {
  display: none;
  position: fixed;
  inset: 0;
  background: #fff;
  z-index: 9999;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 20px;
  padding: 40px;
}
#printArea .pa-title { font-family: 'Rajdhani', sans-serif; font-size: 28px; font-weight: 700; color: #111; }
#printArea .pa-sub { font-size: 14px; color: #555; }
#printArea .pa-qr { background: #fff; padding: 8px; border-radius: 4px; }
#printArea .pa-url { font-family: monospace; font-size: 11px; color: #333; word-break: break-all; max-width: 400px; text-align: center; }
</style>
</head>
<body>

<!-- PRINT AREA -->
<div id="printArea">
  <div class="pa-title" id="pTitle">Armario</div>
  <div class="pa-sub">Escanea para ver la guÃ­a interactiva de componentes</div>
  <div class="pa-qr" id="pQr"></div>
  <div class="pa-url" id="pUrl"></div>
  <button onclick="closePrint()" style="margin-top:16px;padding:8px 20px;border:1px solid #ccc;border-radius:6px;cursor:pointer;font-size:13px;background:#f5f5f5;">âœ• Cerrar</button>
</div>

<!-- HEADER -->
<header id="appHeader">
  <div class="logo">CTRL<em>PANEL</em></div>
  <input class="project-input" id="projectName" type="text" value="Armario sin tÃ­tulo" maxlength="60" placeholder="Nombre del proyectoâ€¦">
  <div class="spacer"></div>
  <button class="hbtn gb" id="btnGH" onclick="openGHModal()">
    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
    GITHUB
  </button>
  <button class="hbtn" id="btnEdit" onclick="toggleEdit()">
    <div class="led"></div>
    EDICIÃ“N
  </button>
  <button class="hbtn share-btn" id="btnShare" onclick="openShare()" disabled style="opacity:.4;cursor:not-allowed;">
    â¬¡ COMPARTIR + QR
  </button>
</header>

<div class="view-badge" id="viewBadge">ğŸ‘ SOLO LECTURA</div>

<!-- WORKSPACE -->
<div class="workspace">
  <div class="image-zone" id="imageZone">
    <div class="drop-zone" id="dropZone">
      <div class="dz-icon">ğŸ“·</div>
      <h2>Foto del armario</h2>
      <p>Arrastra la imagen aquÃ­ o haz clic para seleccionarla</p>
      <label class="dz-btn">Seleccionar imagen
        <input type="file" accept="image/*" id="fileInput" style="display:none" onchange="loadImage(event)">
      </label>
    </div>
    <div class="img-canvas" id="imgCanvas">
      <img id="panelImg" alt="Armario">
    </div>
  </div>

  <div class="side" id="sidePanel">
    <div class="side-empty" id="sideEmpty">
      <div class="se-icon">âš¡</div>
      <h3>Sin componente seleccionado</h3>
      <p id="sideHint">Haz clic en un punto para ver su informaciÃ³n.<br><br>En <strong>Modo EdiciÃ³n</strong>, haz clic sobre la imagen para aÃ±adir un punto nuevo.</p>
    </div>
    <div class="comp-panel" id="compPanel">
      <div class="comp-head" id="compHead"></div>
      <div class="edit-banner" id="editBanner">
        <div class="eb-dot"></div>Modo ediciÃ³n activo
        <button class="eb-save" onclick="saveComp()">ğŸ’¾ GUARDAR</button>
      </div>
      <div class="tabs">
        <div class="tab on" onclick="setTab(0)">FunciÃ³n</div>
        <div class="tab" onclick="setTab(1)">Marca/Modelo</div>
        <div class="tab" onclick="setTab(2)">Uso & Reset</div>
        <div class="tab" onclick="setTab(3)">ParÃ¡metros</div>
      </div>
      <div class="tab-body" id="tabBody"></div>
      <div class="close-row"><button class="cbtn" onclick="closeComp()">âœ• Cerrar</button></div>
    </div>
    <div class="legend">
      <div class="leg"><div class="ldot c"></div>Control</div>
      <div class="leg"><div class="ldot p"></div>Potencia</div>
      <div class="leg"><div class="ldot s"></div>Seguridad</div>
    </div>
  </div>
</div>

<!-- â•â•â•â• GITHUB CONFIG MODAL â•â•â•â• -->
<div class="overlay" id="ghOverlay">
  <div class="modal gh-modal">
    <h3>â¬¡ ConfiguraciÃ³n GitHub</h3>
    <p>Las imÃ¡genes se subirÃ¡n a tu repositorio de GitHub Pages. AsÃ­ las URLs del QR son cortas y escaneables.</p>

    <div class="steps">
      <div class="step done"><div class="step-dot">1</div><span>Repo</span></div>
      <div class="step-line"></div>
      <div class="step active"><div class="step-dot">2</div><span>Token</span></div>
      <div class="step-line"></div>
      <div class="step"><div class="step-dot">3</div><span>Listo</span></div>
    </div>

    <div>
      <label class="field-lbl">Usuario de GitHub</label>
      <input class="field-inp" id="ghUser" placeholder="tu-usuario" type="text">
    </div>
    <div>
      <label class="field-lbl">Nombre del repositorio</label>
      <input class="field-inp" id="ghRepo" placeholder="mi-repo-pages" type="text">
    </div>
    <div>
      <label class="field-lbl">Carpeta para imÃ¡genes (opcional)</label>
      <input class="field-inp" id="ghFolder" placeholder="imagenes" type="text" value="imagenes">
    </div>
    <div>
      <label class="field-lbl">Personal Access Token (classic)</label>
      <input class="field-inp" id="ghToken" placeholder="ghp_xxxxxxxxxxxxxxxx" type="password">
    </div>
    <div class="gh-note">
      ğŸ’¡ Crea un token en <code>GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens â†’ Classic</code>.<br>
      Permisos necesarios: <code>repo</code> (acceso completo al repositorio).
      El token se guarda solo en tu navegador (<code>localStorage</code>).
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeGHModal()">Cancelar</button>
      <button class="btn-ok green" onclick="saveGHConfig()">âœ“ Guardar configuraciÃ³n</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• NEW HOTSPOT FORM â•â•â•â• -->
<div class="overlay" id="hsOverlay">
  <div class="modal hs-modal">
    <h3>âœ¦ Nuevo punto</h3>
    <div>
      <label class="field-lbl">Nombre del componente</label>
      <input class="form-inp" id="f_name" type="text" placeholder="Ej: Variador de frecuencia VF1">
    </div>
    <div>
      <label class="field-lbl">Tipo</label>
      <div class="type-sel" id="typeSelWrap">
        <button class="ts s-ctrl"  onclick="selType('ctrl',this)">â¬¡ Control</button>
        <button class="ts"         onclick="selType('power',this)">âš¡ Potencia</button>
        <button class="ts"         onclick="selType('safe',this)">ğŸ›¡ Seguridad</button>
      </div>
    </div>
    <div>
      <label class="field-lbl">FunciÃ³n (en lenguaje sencillo)</label>
      <textarea class="form-inp" id="f_funcion" rows="3" placeholder="Â¿Para quÃ© sirve este componente?"></textarea>
    </div>
    <div class="form-row">
      <div><label class="field-lbl">Marca</label><input class="form-inp" id="f_marca" type="text" placeholder="Ej: Omron"></div>
      <div><label class="field-lbl">Modelo</label><input class="form-inp" id="f_modelo" type="text" placeholder="Ej: 3G3M1"></div>
    </div>
    <div>
      <label class="field-lbl">DiagnÃ³stico / Indicadores</label>
      <textarea class="form-inp" id="f_uso" rows="2" placeholder="Â¿QuÃ© LEDs mirar? Â¿QuÃ© indica un error?"></textarea>
    </div>
    <div>
      <label class="field-lbl">Pasos para reset</label>
      <input class="form-inp" id="f_reset" type="text" placeholder="Ej: Desbloquear seta â†’ Pulsar RESET">
    </div>
    <div>
      <label class="field-lbl">âš  Aviso de seguridad (opcional)</label>
      <input class="form-inp" id="f_aviso" type="text" placeholder="Ej: 400VAC â€” No manipular con tensiÃ³n">
    </div>
    <div>
      <label class="field-lbl">ParÃ¡metros tÃ©cnicos <span style="color:var(--muted);font-weight:400;">(Clave: Valor, separados por coma)</span></label>
      <input class="form-inp" id="f_params" type="text" placeholder="TensiÃ³n: 400VAC, Potencia: 2.2kW, Norma: IEC60068">
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="cancelHs()">Cancelar</button>
      <button class="btn-ok" onclick="confirmHs()">âœ“ Crear punto</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• SHARE / QR MODAL â•â•â•â• -->
<div class="overlay" id="shareOverlay">
  <div class="modal share-modal">
    <h3>â¬¡ Enlace de cliente + QR</h3>

    <div class="upload-progress" id="uploadProgress">
      <span id="uploadMsg">Subiendo imagen a GitHubâ€¦</span>
      <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar"></div></div>
    </div>

    <div id="shareContent" style="display:none;flex-direction:column;gap:16px;">
      <p>Enlace de <strong>solo lectura</strong> para tu cliente. Escanea el QR o copia la URL.</p>
      <div class="url-row">
        <div class="url-box" id="shareUrl">â€”</div>
        <button class="copy-btn" onclick="copyUrl()">COPIAR</button>
      </div>

      <div class="qr-section">
        <div class="qr-wrap"><div id="qrcode"></div></div>
        <div class="qr-info">
          <h4>QR listo para imprimir</h4>
          <p>Pega este cÃ³digo en la documentaciÃ³n del armario o en una etiqueta adhesiva en la puerta.</p>
          <button class="print-btn" onclick="printQR()">ğŸ–¨ Imprimir QR</button>
        </div>
      </div>

      <div class="gh-note" style="font-size:12px;">
        âœ… Imagen alojada en GitHub Â· Solo los datos textuales van en la URL Â· El QR es escaneable con cualquier mÃ³vil
      </div>
    </div>

    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeShare()">Cerrar</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UNICODE-SAFE BASE64
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toB64(str) {
  const bytes = new TextEncoder().encode(str);
  let bin = '';
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin);
}
function fromB64(b64) {
  const bin = atob(b64);
  const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
  return new TextDecoder().decode(bytes);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  projectName: 'Armario sin tÃ­tulo',
  imageUrl: null,      // raw GitHub URL â€” short!
  hotspots: []
};

let ghConfig = { user:'', repo:'', folder:'imagenes', token:'' };
let editMode = false;
let viewOnly = false;
let currentId = null;
let currentTab = 0;
let pendingPos = null;
let selType_ = 'ctrl';
let nextId = 1;
let currentShareUrl = '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', () => {
  // Load GH config from localStorage
  try {
    const saved = localStorage.getItem('ctrlpanel_gh');
    if (saved) {
      ghConfig = JSON.parse(saved);
      updateGHBtn();
    }
  } catch(e) {}

  // Check view-only hash
  const hash = location.hash.slice(1);
  if (hash.startsWith('v=')) {
    try {
      const decoded = fromB64(decodeURIComponent(hash.slice(2)));
      state = JSON.parse(decoded);
      viewOnly = true;
      initViewOnly();
    } catch(e) { console.warn('Hash parse error', e); }
  }

  // Drag & drop
  const dz = document.getElementById('dropZone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', e => {
    e.preventDefault();
    dz.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) handleImageFile(file);
  });
  dz.addEventListener('click', e => {
    if (e.target.tagName !== 'INPUT') document.getElementById('fileInput').click();
  });

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { cancelHs(); closeShare(); closeGHModal(); }
  });
});

function initViewOnly() {
  document.getElementById('appHeader').style.display = 'none';
  document.getElementById('viewBadge').style.display = 'block';
  document.getElementById('sideHint').innerHTML = 'Haz clic en un punto numerado para ver la informaciÃ³n del componente.';
  document.title = state.projectName + ' â€” Vista cliente';
  if (state.imageUrl) loadImageFromUrl(state.imageUrl);
  renderHotspots();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GITHUB CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openGHModal() {
  document.getElementById('ghUser').value   = ghConfig.user;
  document.getElementById('ghRepo').value   = ghConfig.repo;
  document.getElementById('ghFolder').value = ghConfig.folder || 'imagenes';
  document.getElementById('ghToken').value  = ghConfig.token;
  document.getElementById('ghOverlay').classList.add('show');
}
function closeGHModal() {
  document.getElementById('ghOverlay').classList.remove('show');
}
function saveGHConfig() {
  ghConfig.user   = document.getElementById('ghUser').value.trim();
  ghConfig.repo   = document.getElementById('ghRepo').value.trim();
  ghConfig.folder = document.getElementById('ghFolder').value.trim() || 'imagenes';
  ghConfig.token  = document.getElementById('ghToken').value.trim();
  if (!ghConfig.user || !ghConfig.repo || !ghConfig.token) {
    alert('Por favor rellena usuario, repositorio y token.');
    return;
  }
  localStorage.setItem('ctrlpanel_gh', JSON.stringify(ghConfig));
  updateGHBtn();
  closeGHModal();
}
function updateGHBtn() {
  const btn = document.getElementById('btnGH');
  if (ghConfig.user && ghConfig.repo && ghConfig.token) {
    btn.classList.add('configured');
    btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg> ${ghConfig.user}/${ghConfig.repo} âœ“`;
  } else {
    btn.classList.remove('configured');
    btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg> GITHUB`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMAGE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pendingImageFile = null;

function loadImage(e) {
  const file = e.target.files[0];
  if (file) handleImageFile(file);
}

function handleImageFile(file) {
  pendingImageFile = file;
  const reader = new FileReader();
  reader.onload = ev => {
    loadImageFromUrl(ev.target.result);
    // Enable share only if GH configured, else still preview
    updateShareBtn();
  };
  reader.readAsDataURL(file);
}

function loadImageFromUrl(url) {
  document.getElementById('dropZone').style.display = 'none';
  const canvas = document.getElementById('imgCanvas');
  canvas.style.display = 'block';
  document.getElementById('panelImg').src = url;
}

function updateShareBtn() {
  const btn = document.getElementById('btnShare');
  const ready = (state.imageUrl || pendingImageFile) && ghConfig.token;
  btn.disabled = !ready;
  btn.style.opacity = ready ? '1' : '0.4';
  btn.style.cursor = ready ? 'pointer' : 'not-allowed';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPLOAD TO GITHUB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function uploadImageToGitHub(file) {
  const filename = `armario_${Date.now()}.jpg`;
  const path = `${ghConfig.folder}/${filename}`;

  // Compress image first
  const compressed = await compressImage(file, 1400, 0.82);
  const base64 = compressed.split(',')[1];

  const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`;

  const res = await fetch(url, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${ghConfig.token}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github.v3+json'
    },
    body: JSON.stringify({
      message: `Subir imagen armario: ${state.projectName}`,
      content: base64
    })
  });

  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.message || 'Error subiendo a GitHub');
  }

  const data = await res.json();
  // Return the raw URL for direct access
  return `https://raw.githubusercontent.com/${ghConfig.user}/${ghConfig.repo}/main/${path}`;
}

async function compressImage(file, maxSize, quality) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => {
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > maxSize) { h = Math.round(h * maxSize / w); w = maxSize; }
        if (h > maxSize) { w = Math.round(w * maxSize / h); h = maxSize; }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleEdit() {
  if (!document.getElementById('panelImg').src || document.getElementById('panelImg').src === location.href) {
    alert('Primero sube una imagen del armario.');
    return;
  }
  editMode = !editMode;
  const btn = document.getElementById('btnEdit');
  btn.classList.toggle('edit-on', editMode);
  document.body.classList.toggle('edit-mode-on', editMode);
  document.getElementById('imgCanvas').classList.toggle('crosshair', editMode);
  if (currentId !== null) {
    document.getElementById('editBanner').classList.toggle('show', editMode);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLICK ON IMAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('imgCanvas').addEventListener('click', e => {
  if (!editMode || viewOnly) return;
  if (e.target.closest('.hs')) return;
  const img = document.getElementById('panelImg');
  const rect = img.getBoundingClientRect();
  pendingPos = {
    x: parseFloat(((e.clientX - rect.left) / rect.width * 100).toFixed(2)),
    y: parseFloat(((e.clientY - rect.top)  / rect.height * 100).toFixed(2))
  };
  openHsForm();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOTSPOT FORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openHsForm() {
  ['f_name','f_funcion','f_marca','f_modelo','f_uso','f_reset','f_aviso','f_params']
    .forEach(id => document.getElementById(id).value = '');
  selType_ = 'ctrl';
  document.querySelectorAll('.ts').forEach(b => b.className = 'ts');
  document.querySelector('.ts').classList.add('s-ctrl');
  document.getElementById('hsOverlay').classList.add('show');
  setTimeout(() => document.getElementById('f_name').focus(), 80);
}
function cancelHs() { document.getElementById('hsOverlay').classList.remove('show'); pendingPos = null; }

function selType(type, btn) {
  selType_ = type;
  document.querySelectorAll('.ts').forEach(b => b.className = 'ts');
  btn.classList.add('s-' + type);
}

function parseParams(str) {
  if (!str.trim()) return [{k:'TensiÃ³n',v:'â€”'},{k:'Corriente',v:'â€”'},{k:'Potencia',v:'â€”'},{k:'Norma',v:'â€”'}];
  return str.split(',').map(s => {
    const [k,...rest] = s.split(':');
    return { k: k?.trim() || 'â€”', v: rest.join(':').trim() || 'â€”' };
  });
}

function confirmHs() {
  const labels = { ctrl:'CONTROL', power:'POTENCIA', safe:'SEGURIDAD' };
  const hs = {
    id: nextId++,
    x: pendingPos.x, y: pendingPos.y,
    tipo: selType_,
    tipoLabel: labels[selType_],
    name:    document.getElementById('f_name').value.trim()    || 'Componente',
    marca:   document.getElementById('f_marca').value.trim()   || 'â€”',
    modelo:  document.getElementById('f_modelo').value.trim()  || 'â€”',
    funcion: document.getElementById('f_funcion').value.trim() || 'â€”',
    uso:     document.getElementById('f_uso').value.trim()     || 'â€”',
    reset:   document.getElementById('f_reset').value.trim()   || 'â€”',
    aviso:   document.getElementById('f_aviso').value.trim()   || null,
    params:  parseParams(document.getElementById('f_params').value)
  };
  state.hotspots.push(hs);
  document.getElementById('hsOverlay').classList.remove('show');
  pendingPos = null;
  addHotspotEl(hs);
  showComp(hs.id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOTSPOT ELEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHotspots() {
  document.querySelectorAll('.hs').forEach(h => h.remove());
  state.hotspots.forEach(addHotspotEl);
}

function addHotspotEl(hs) {
  const canvas = document.getElementById('imgCanvas');
  const el = document.createElement('div');
  el.className = `hs ${hs.tipo}`;
  el.id = 'hs_' + hs.id;
  el.dataset.id = hs.id;
  el.style.left = hs.x + '%';
  el.style.top  = hs.y + '%';
  el.innerHTML = `<div class="hs-ring">${hs.id}</div><div class="hs-tip">${hs.name}</div><div class="hs-del">âœ•</div>`;
  el.querySelector('.hs-ring').addEventListener('click', () => showComp(hs.id));
  el.querySelector('.hs-del').addEventListener('click', e => { e.stopPropagation(); deleteHs(hs.id); });
  canvas.appendChild(el);
}

function deleteHs(id) {
  if (!confirm('Â¿Eliminar este punto?')) return;
  state.hotspots = state.hotspots.filter(h => h.id !== id);
  document.getElementById('hs_' + id)?.remove();
  if (currentId === id) closeComp();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHOW COMPONENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showComp(id) {
  currentId = id;
  currentTab = 0;
  const hs = state.hotspots.find(h => h.id === id);
  if (!hs) return;
  document.querySelectorAll('.hs').forEach(h => h.classList.remove('active'));
  document.getElementById('hs_' + id)?.classList.add('active');
  const cbMap = { ctrl:'cb-ctrl', power:'cb-power', safe:'cb-safe' };
  document.getElementById('compHead').innerHTML = `
    <div class="comp-badge ${cbMap[hs.tipo]}">${hs.tipoLabel}</div>
    <div class="comp-name-h">${hs.name}</div>
    <div class="comp-model-h">${hs.marca} Â· ${hs.modelo}</div>`;
  document.getElementById('editBanner').classList.toggle('show', editMode && !viewOnly);
  renderTab(hs);
  document.getElementById('sideEmpty').style.display = 'none';
  document.getElementById('compPanel').classList.add('show');
}

function renderTab(hs) {
  const ed = (editMode && !viewOnly) ? 'contenteditable="true"' : '';
  const tabs = [
    `<div class="fblock"><div class="fl">Â¿Para quÃ© sirve?</div><div class="fv" ${ed}>${hs.funcion}</div></div>
     ${hs.aviso ? `<div class="warn-box"><span>âš ï¸</span><span ${ed}>${hs.aviso}</span></div>` : ''}`,
    `<div class="fblock"><div class="fl">Fabricante</div><div class="fv card" ${ed}>${hs.marca}</div></div>
     <div class="fblock"><div class="fl">Referencia / UbicaciÃ³n</div><div class="fv card" ${ed}>${hs.modelo}</div></div>`,
    `<div class="fblock"><div class="fl">CÃ³mo identificar un problema</div><div class="fv hl" ${ed}>${hs.uso}</div></div>
     <div class="fblock"><div class="fl">Pasos para reset</div><div class="fv card" ${ed}>${hs.reset}</div></div>`,
    `<div class="params-grid">${hs.params.map(p=>`<div class="param-chip"><div class="pk">${p.k}</div><div class="pv" ${ed}>${p.v}</div></div>`).join('')}</div>`
  ];
  document.getElementById('tabBody').innerHTML = tabs[currentTab];
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('on', i === currentTab));
}

function setTab(i) {
  currentTab = i;
  const hs = state.hotspots.find(h => h.id === currentId);
  if (hs) renderTab(hs);
}

function closeComp() {
  document.querySelectorAll('.hs').forEach(h => h.classList.remove('active'));
  document.getElementById('sideEmpty').style.display = '';
  document.getElementById('compPanel').classList.remove('show');
  document.getElementById('editBanner').classList.remove('show');
  currentId = null;
}

function saveComp() {
  const hs = state.hotspots.find(h => h.id === currentId);
  if (!hs) return;
  const ce = document.getElementById('tabBody').querySelectorAll('[contenteditable]');
  if (currentTab === 0) { if(ce[0]) hs.funcion=ce[0].innerText.trim(); if(ce[1]&&hs.aviso) hs.aviso=ce[1].innerText.trim(); }
  else if (currentTab === 1) { if(ce[0]) hs.marca=ce[0].innerText.trim(); if(ce[1]) hs.modelo=ce[1].innerText.trim(); }
  else if (currentTab === 2) { if(ce[0]) hs.uso=ce[0].innerText.trim(); if(ce[1]) hs.reset=ce[1].innerText.trim(); }
  else if (currentTab === 3) { ce.forEach((el,i)=>{ if(hs.params[i]) hs.params[i].v=el.innerText.trim(); }); }
  const cbMap = {ctrl:'cb-ctrl',power:'cb-power',safe:'cb-safe'};
  document.getElementById('compHead').innerHTML = `
    <div class="comp-badge ${cbMap[hs.tipo]}">${hs.tipoLabel}</div>
    <div class="comp-name-h">${hs.name}</div>
    <div class="comp-model-h">${hs.marca} Â· ${hs.modelo}</div>`;
  const btn = document.querySelector('.eb-save');
  btn.textContent='âœ“ OK'; btn.style.color='var(--green)'; btn.style.borderColor='var(--green)';
  setTimeout(()=>{ btn.textContent='ğŸ’¾ GUARDAR'; btn.style.color=''; btn.style.borderColor=''; }, 2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHARE + QR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openShare() {
  if (!ghConfig.user || !ghConfig.token) {
    alert('Configura primero tu cuenta de GitHub haciendo clic en el botÃ³n GITHUB.');
    return;
  }
  if (!pendingImageFile && !state.imageUrl) {
    alert('Sube una imagen del armario primero.');
    return;
  }

  state.projectName = document.getElementById('projectName').value || 'Armario';

  // Show modal with progress
  document.getElementById('shareOverlay').classList.add('show');
  document.getElementById('shareContent').style.display = 'none';
  const prog = document.getElementById('uploadProgress');
  prog.classList.add('show');
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('uploadMsg').textContent = 'Subiendo imagen a GitHubâ€¦';

  try {
    // Animate progress bar
    let pct = 0;
    const tick = setInterval(() => {
      pct = Math.min(pct + 8, 85);
      document.getElementById('progressBar').style.width = pct + '%';
    }, 200);

    // Upload if we have a new file
    if (pendingImageFile) {
      state.imageUrl = await uploadImageToGitHub(pendingImageFile);
      pendingImageFile = null; // clear so we don't re-upload
    }

    clearInterval(tick);
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('uploadMsg').textContent = 'âœ“ Imagen subida Â· Generando enlaceâ€¦';

    await new Promise(r => setTimeout(r, 500));

    // Build short URL â€” only text data in hash, image is a URL reference
    const payload = JSON.stringify(state);
    const encoded = encodeURIComponent(toB64(payload));
    const shareUrl = location.origin + location.pathname + '#v=' + encoded;
    currentShareUrl = shareUrl;

    document.getElementById('shareUrl').textContent = shareUrl;

    // Generate QR
    document.getElementById('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), {
      text: shareUrl,
      width: 160,
      height: 160,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });

    prog.classList.remove('show');
    document.getElementById('shareContent').style.display = 'flex';

    // Update share btn
    updateShareBtn();

  } catch(err) {
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('uploadMsg').textContent = 'âŒ Error: ' + err.message;
    document.getElementById('progressBar').style.background = 'var(--red)';
    console.error(err);
  }
}

function closeShare() {
  document.getElementById('shareOverlay').classList.remove('show');
  document.getElementById('progressBar').style.background = '';
}

function copyUrl() {
  navigator.clipboard.writeText(currentShareUrl).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = 'âœ“ COPIADO';
    btn.style.background = 'rgba(46,204,113,.3)';
    setTimeout(() => { btn.textContent = 'COPIAR'; btn.style.background = ''; }, 2200);
  });
}

function printQR() {
  // Build a print-friendly page
  document.getElementById('pTitle').textContent = state.projectName;
  document.getElementById('pUrl').textContent = currentShareUrl;

  const printQrEl = document.getElementById('pQr');
  printQrEl.innerHTML = '';
  new QRCode(printQrEl, {
    text: currentShareUrl,
    width: 220,
    height: 220,
    colorDark: '#000000',
    colorLight: '#ffffff',
    correctLevel: QRCode.CorrectLevel.M
  });

  setTimeout(() => {
    document.getElementById('printArea').style.display = 'flex';
    window.print();
  }, 300);
}

function closePrint() {
  document.getElementById('printArea').style.display = 'none';
}
</script>
</body>
</html>
